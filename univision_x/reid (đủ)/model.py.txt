import torch
import torch.nn as nn
import torch.nn.functional as F
from torchvision import models


class ReIDEncoder(nn.Module):
    """
    ReID embedding network
    Output: L2-normalized embedding
    """
    def __init__(self, emb_dim=128):
        super().__init__()

        backbone = models.resnet50(pretrained=True)
        self.backbone = nn.Sequential(*list(backbone.children())[:-2])

        self.pool = nn.AdaptiveAvgPool2d(1)
        self.fc = nn.Linear(2048, emb_dim)

        nn.init.kaiming_normal_(self.fc.weight)

    def forward(self, x):
        x = self.backbone(x)
        x = self.pool(x).flatten(1)
        x = self.fc(x)
        return F.normalize(x, p=2, dim=1)
